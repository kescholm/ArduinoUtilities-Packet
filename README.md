# ArduinoUtilities-Packet

An Arduino library to pack and unpack data over a stream buffer. The packet includes a delimiter and size header with an optional CRC appended to the buffer packet. Utility functions for the Arduino `Serial` interface is included but the packet can also be used with sockets or other data stream interfaces.

## Prerequisites

Install [Platform.IO](https://docs.platformio.org/en/latest/) for your IDE. If you want to use the command line, append `"$HOME/.platformio/penv/bin"` to your `PATH` environment variable as instructed by [platformio documentation](https://docs.platformio.org/en/latest/core/installation.html#install-shell-commands).

## Use the Library with Platform.IO or Arduino

In your project, simply add this library in your platform.ini file:

```ini
; Library dependencies
lib_deps =
    ArduinoUtilities-Packet
```

For more information about libraries for Platform.IO, read up on the [Library Dependency Finder](https://docs.platformio.org/en/latest/librarymanager/ldf.html#ldf)

### Example Usage

It is recommended to define preprocessor constant for the serial baudrate so it can be changed with configurations for other hardware.

```cpp
#ifndef SERIAL_BAUDRATE
#define SERIAL_BAUDRATE 115200
#endif
```

In your setup, create packet object.

```cpp
#include "ArdPacket.h"

// Packet Parameters
// max size of send buffer
size_t max_size = 120;
// packet delimiter
uint8_t delimiter = '|';
// crc
bool use_crc = true;

// Initialize and allocate memory for packet objects. One for read, the other write;
ArdPacket read_packet;
ArdPacket write_packet;
// allocate read
int result = ard_packet_alloc(&read_packet, max_size, delimiter, use_crc);
if (result != 0) {
    // Error allocating memory and setting parameters
}
// allocate write
result = ard_packet_alloc(&write_packet, max_size, delimiter, use_crc);
if (result != 0) {
    // Error allocating memory and setting parameters
}
```

In the setup, start serial communications.

```cpp
// start serial
ard_serial_begin(SERIAL_BAUDRATE);
```

The read packet object should be used to poll `Serial` for data available. The following code snippet uses a busy-loop for simplicity but it's recommended to implement an interrupt timer for your main control loop.

```cpp
// initialize microsecond timer (can be done in setup())
uint32_t timing_now = micros();
uint32_t timing_prev = timing_now;
uint32_t timing_step_size = parameters.command_step_size;

// loop forever
void loop(void) {
    // TODO: sample loop
}
```

## Setup for Development

If using VS Code, you can easily [install recommended extensions](https://code.visualstudio.com/docs/editor/extension-gallery#_recommended-extensions) for this project.

### Run Examples

Examples are useful when developing the library code. See example code in [examples](./examples/README) folder. Copy and paste source files from example directory to `src` folder then build using Platform.IO. For example:

```sh
cp -r examples/examples/ArdPacket-CountToValue/* src/
pio run -e atmega328
```

Do not commit any example files in the `src` directory. There must not be any `main` function in the source files for an Arduino library.

### Format Source Files

Source formatting uses LLVM's [Clang Format](https://clang.llvm.org/docs/ClangFormat.html) and the configuration is provided in [`.clang-format`](.clang-format). The configuration is based on default Google style (generated by clang-format version 10.0.0) with `IndentWidth` set to 4 and `ColumnLimit` set to 100.

### Unit Testing

Please read up on Platform.IO unit testing here: [https://docs.platformio.org/en/latest/plus/unit-testing.html](https://docs.platformio.org/en/latest/plus/unit-testing.html). Unit tests are in the `test` folder.

For embedded testing with hardware connected by serial ports, set proper upload ports and optionally modify platform.ini with different boards. For example:

```sh
pio test -e esp32 --upload-port /dev/ttyUSB0
pio test -e atmega328 --upload-port /dev/ttyUSB1
```

### CRC Code Generation

Code was generated using [pycrc](https://pypi.org/project/pycrc/).

```python
python -m pycrc --model kermit --algorithm table-driven --generate h -o ArdCrc.h
python -m pycrc --model kermit --algorithm table-driven --generate c -o ArdCrc.c
```
